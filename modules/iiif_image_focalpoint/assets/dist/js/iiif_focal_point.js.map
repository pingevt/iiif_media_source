{"version":3,"file":"iiif_focal_point.js","sources":["../../src/js/iiif_focal_point.js"],"sourcesContent":["/**\n * @file\n * Javascript functionality for the focal point widget.\n */\n\n(function ($, Drupal) {\n  'use strict';\n\n  let fps = [];\n\n  /**\n   * Focal Point indicator.\n   */\n  Drupal.behaviors.iiifFocalPointIndicator = {\n    attach: function (context) {\n\n      once('iiif-focal-point-hide-field', '.focal-point', context).forEach(function(el) {\n        var $wrapper = $(el).closest('.iiif-focal-point-wrapper');\n        // Add the \"visually-hidden\" class unless the focal point offset field\n        // has an error. This will show the field for everyone when there is an\n        // error and for non-sighted users no matter what. We add it the\n        // form item to make sure the field is focusable while\n        // the entire form item is hidden for sighted users.\n        if (!$(el).hasClass('error')) {\n          $wrapper.addClass('visually-hidden');\n          $(el).on('focus', function () {\n            $wrapper.removeClass('visually-hidden');\n          }).on('blur', function () {\n            $wrapper.addClass('visually-hidden');\n          });\n        }\n      });\n\n      once('iiif-focal-point-hide-field', '.iiif-focal-point-indicator', context).forEach(function(el) {\n\n        // Set some variables for the different pieces at play.\n        var $indicator = $(el);\n        var $img = $(el).siblings('img');\n        var $previewLink = $(el).siblings('.iiif-focal-point-preview-link');\n        var $field = $(\".\" + $(el).attr('data-selector'));\n        var fp = new Drupal.IiifFocalPoint($indicator, $img, $field, $previewLink);\n\n        fps.push(fp);\n\n        // Set the position of the indicator on image load and any time the\n        // field value changes. We use a bit of hackery to make certain that the\n        // image is loaded before moving the crosshair. See http://goo.gl/B02vFO\n        // The setTimeout was added to ensure the focal point is set properly on\n        // modal windows. See http://goo.gl/s73ge.\n        setTimeout(function () {\n          $img.one('load', function () {\n            fp.setIndicator();\n          }).each(function () {\n            if (this.complete) {\n              $(this).trigger('load');\n            }\n          });\n        }, 0);\n\n      });\n    }\n\n  };\n\n  /**\n   * Object representing the focal point for a given image.\n   *\n   * @param $indicator object\n   *   The indicator jQuery object whose position should be set.\n   * @param $img object\n   *   The image jQuery object to which the indicator is attached.\n   * @param $field array\n   *   The field jQuery object where the position can be found.\n   * @param $previewLink object\n   *   The previewLink jQuery object.\n   */\n  Drupal.IiifFocalPoint = function ($indicator, $img, $field, $previewLink) {\n    var self = this;\n\n    this.$indicator = $indicator;\n    this.$img = $img;\n    this.$field = $field;\n    this.$previewLink = $previewLink;\n\n    // Make the focal point indicator draggable and tell it to update the\n    // appropriate field when it is moved by the user.\n    this.$indicator.draggable({\n      containment: self.$img,\n      stop: function () {\n        var imgOffset = self.$img.offset();\n        var iiifFocalPointOffset = self.$indicator.offset();\n\n        var leftDelta = iiifFocalPointOffset.left - imgOffset.left;\n        var topDelta = iiifFocalPointOffset.top - imgOffset.top;\n\n        self.set(leftDelta, topDelta);\n      }\n    });\n\n    // Allow users to double-click the indicator to reveal the focal point form\n    // element.\n    this.$indicator.on('dblclick', function () {\n      self.$field.closest('.iiif-focal-point-wrapper').toggleClass('visually-hidden');\n    });\n\n    // Allow users to click on the image preview in order to set the focalpoint\n    // and set a cursor.\n    this.$img.on('click', function (event) {\n      self.set(event.offsetX, event.offsetY);\n    });\n    this.$img.css('cursor', 'crosshair');\n\n    // Add a change event to the focal point field so it will properly update\n    // the indicator position and preview link.\n    this.$field.on('change', function () {\n     $(document).trigger('drupalIiifFocalPointSet', { $iiifFocalPoint: self });\n    });\n\n    // Wrap the focal point indicator and thumbnail image in a div so that\n    // everything still works with RTL languages.\n    this.$indicator.add(this.$img).add(this.$previewLink).wrapAll(\"<div class='iiif-focal-point-wrapper' />\");\n  };\n\n  /**\n   * Set the focal point.\n   *\n   * @param offsetX int\n   *   Left offset in pixels.\n   * @param offsetY int\n   *   Top offset in pixels.\n   */\n  Drupal.IiifFocalPoint.prototype.set = function (offsetX, offsetY) {\n    var iiifFocalPoint = this.calculate(offsetX, offsetY);\n    this.$field.val(iiifFocalPoint.x + ',' + iiifFocalPoint.y).trigger('change');\n\n    $(document).trigger('drupalIiifFocalPointSet', { $iiifFocalPoint: this });\n  };\n\n  /**\n   * Change the position of the focal point indicator. This may not work in IE7.\n   */\n  Drupal.IiifFocalPoint.prototype.setIndicator = function () {\n    var coordinates = this.$field.val() !== '' && this.$field.val() !== undefined ? this.$field.val().split(',') : [50,50];\n\n    var left = Math.min(this.$img.width(), (parseInt(coordinates[0], 10) / 100) * this.$img.width());\n    var top = Math.min(this.$img.height(), (parseInt(coordinates[1], 10) / 100) * this.$img.height());\n\n    this.$indicator.css('left', Math.max(0, left));\n    this.$indicator.css('top', Math.max(0,top));\n    this.$field.val(coordinates[0] + ',' + coordinates[1]);\n  };\n\n  /**\n   * Calculate the focal point for the given image.\n   *\n   * @param offsetX int\n   *   Left offset in pixels.\n   * @param offsetY int\n   *   Top offset in pixels.\n   *\n   * @returns object\n   */\n  Drupal.IiifFocalPoint.prototype.calculate = function (offsetX, offsetY) {\n    var iiifFocalPoint = {};\n    iiifFocalPoint.x = this.round(100 * offsetX / this.$img.width(), 0, 100);\n    iiifFocalPoint.y = this.round(100 * offsetY / this.$img.height(), 0, 100);\n\n    return iiifFocalPoint;\n  };\n\n  /**\n   * Rounds the given value to the nearest integer within the given bounds.\n   *\n   * @param value float\n   *   The value to round.\n   * @param min int\n   *   The lower bound.\n   * @param max int\n   *   The upper bound.\n   *\n   * @returns int\n   */\n  Drupal.IiifFocalPoint.prototype.round = function (value, min, max) {\n    var roundedVal = Math.max(Math.round(value), min);\n    roundedVal = Math.min(roundedVal, max);\n\n    return roundedVal;\n  };\n\n  /**\n   * Update the Focal Point indicator and preview link when focal point changes.\n   *\n   * @param {jQuery.Event} event\n   *   The `drupalIiifFocalPointSet` event.\n   * @param {object} data\n   *   An object containing the data relevant to the event.\n   *\n   * @listens event:drupalIiifFocalPointSet\n   */\n  $(document).on('drupalIiifFocalPointSet', function (event, data) {\n    data.$iiifFocalPoint.setIndicator();\n  });\n\n  /**\n   * When resizing, update indicators.\n   */\n  $(window).on('resize', function (event, data) {\n    fps.forEach((fp) => {\n      $(document).trigger('drupalIiifFocalPointSet', { $iiifFocalPoint: fp });\n    });\n  });\n\n  /**\n   * If FP is in a tab we need to reset when tab is opened.\n   */\n  // Todo: narrow this down\n  $(window).on('click', function (event, data) {\n    fps.forEach((fp) => {\n      $(document).trigger('drupalIiifFocalPointSet', { $iiifFocalPoint: fp });\n    });\n  });\n})(jQuery, Drupal);\n"],"names":[],"mappings":"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"}